#!/singularity/test
# Example script using bash syntax

source ${SOURCEDIR}/tests/scripts/common.func

image=`get-test-image`

expect-success "BasicTrue"              true
expect-failure "BasicFalse"             false
expect-success "SingularityExecTrue"    singularity exec ${image} true
expect-failure "SingularityExecFalse"   singularity exec ${image} false
expect-success "SingularityVersionOK"   singularity --version
expect-failure "SingularityVersionKO"   singularity ---version

stderr-contains "SingularityError" "Available Commands:" singularity
stdout-contains "ExecPID1"         "sinit"               singularity exec -p ${image} cat /proc/1/comm
stdout-contains "ExecPID1NoInit"   "sh"                  singularity exec -p --no-init ${image} /bin/sh -c "sleep 0.2; cat /proc/1/comm"

TEST="this_is_a_test"
echo $TEST | stdout-contains "SingularitySTDINPipe" "${TEST}" singularity -d exec -u ${image} cat 2>/tmp/output

test-log "Hello from test"

for i in $(seq 1 4); do
    expect-success "InstanceStart${i}"  singularity instance start ${image} testing${i}
    expect-success "InstanceStop${i}"   singularity instance stop testing${i}
done

stdout-contains "SudoHome"  "HOME=/root"                            ${SUDO} env
stdout-contains "SudoCache" "SINGULARITY_CACHEDIR=${CACHEDIR_PRIV}" ${SUDO} env