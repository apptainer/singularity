#!/singularity/test
# persistent overlay tests

source ${SOURCEDIR}/tests/scripts/common.func

# check overlay is supported, or skip those tests
check-overlayfs

# check command presence
check-command mksquashfs
check-command dd
check-command mkfs.ext3

# test staging files/directories
ext3_overlay_image=`mktmpfile`
overlaydir=`mktmpdir`
squashdir=`mktmpdir`
squash_overlay_img=`mktmpfile`
echo "bogus" > ${squashdir}/squash_overlay

# create overlay images
run-command mksquashfs ${squashdir} ${squash_overlay_img} -noappend
run-command dd if=/dev/zero of=${ext3_overlay_image} bs=1M count=64
run-command mkfs.ext3 -q -F ${ext3_overlay_image}

# get test image
image=`get-test-image`

# test directory overlay
expect-success "TouchWithDirOverlay"        ${SUDO} singularity exec -o ${overlaydir} ${image} touch /dir_overlay
expect-success "CheckDirOverlay"            ${SUDO} singularity exec -o ${overlaydir} ${image} test -f /dir_overlay

# test ext3 overlay
expect-success "TouchWithExt3Overlay"       ${SUDO} singularity exec -o ${ext3_overlay_image} ${image} touch /ext3_overlay
expect-success "CheckExt3Overlay"           ${SUDO} singularity exec -o ${ext3_overlay_image} ${image} test -f /ext3_overlay

# test squashfs overlay
expect-success "CheckSquashOverlay"         ${SUDO} singularity exec -o ${squash_overlay_img} ${image} test -f /squash_overlay

# test multiple overlay
expect-success "TouchWithMultipleOverlay"   ${SUDO} singularity exec -o ${ext3_overlay_image} -o ${squash_overlay_img} ${image} touch /multiple_overlay_fs
expect-success "CheckMultipleOverlay"       ${SUDO} singularity exec -o ${ext3_overlay_image} -o ${squash_overlay_img} ${image} test -f /multiple_overlay_fs
expect-success "CheckSquashMultipleOverlay" ${SUDO} singularity exec -o ${ext3_overlay_image} -o ${squash_overlay_img} ${image} test -f /squash_overlay

# test without privileges
expect-failure  "BadCheckOverlayNoPriv"     singularity exec ${image} test -f /ext3_overlay
expect-exit 255 "CheckDirOverlayNoPriv"     singularity exec -o ${overlaydir} ${image} test -f /dir_overlay
expect-success  "CheckExt3OverlayNoPriv"    singularity exec -o ${ext3_overlay_image} ${image} test -f /ext3_overlay
expect-success  "CheckSquashOverlayNoPriv"  singularity exec -o ${squash_overlay_img} ${image} test -f /squash_overlay