#!/singularity/test
# test from docker registry

source ${SOURCEDIR}/tests/scripts/common.func

check-command docker

atexit() {
    # delete local registry when script terminates
    docker kill registry >/dev/null 2>&1
    docker rm registry >/dev/null 2>&1
}

tmpdir=`mktmpdir`
tmpimage="${tmpdir}/container.sif"

# prepare registry
run-command docker run -d -p 5000:5000 --restart=always --name registry registry:2
run-command docker pull busybox
run-command docker tag busybox localhost:5000/my-busybox
run-command docker push localhost:5000/my-busybox

# local registry without https setup
export SINGULARITY_NOHTTPS=1

expect-success  "BusyboxLocal"                  ${SUDO} singularity build ${tmpimage} ${SOURCEDIR}/tests/scripts/docker/definition_files/busybox_local.def
verify-image    "BusyboxLocal"                  ${tmpimage}

expect-success  "BusyboxLocalRegistry"          ${SUDO} singularity build ${tmpimage} ${SOURCEDIR}/tests/scripts/docker/definition_files/busybox_local_registry.def
verify-image    "BusyboxLocalRegistry"          ${tmpimage}

expect-failure  "BusyboxLocalRegistryNamespace" ${SUDO} singularity build ${tmpimage} ${SOURCEDIR}/tests/scripts/docker/definition_files/busybox_local_registry_namespace.def