language: go

sudo: required
dist: trusty

go:
  - "1.10.x"

addons:
  apt:
    packages:
      - flawfinder
      - squashfs-tools
      - uuid-dev
      - libuuid1
      - libssl-dev
      - libssl1.0.0
      - libarchive-dev
      - libgpgme11-dev

before_install:
  - curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
  - export PATH="${GOPATH}/bin:${PATH}"
  - dep ensure -vendor-only

install:
  - ./mconfig -p /usr/local
  - make -j `nproc 2>/dev/null || echo 1` -C ./builddir
  - sudo make -C ./builddir install

script:
  - export CGO_CPPFLAGS="-I${GOPATH}/src/github.com/singularityware/singularity/builddir -I${GOPATH}/src/github.com/singularityware/singularity/src/runtime/c -I${GOPATH}/src/github.com/singularityware/singularity/src/runtime/c/lib"
  - export CGO_LDFLAGS="-L${GOPATH}/src/github.com/singularityware/singularity/builddir/lib"
  - test -z $(go fmt ./...)
  - go vet -all ./...
  - go test -coverprofile cover.out -race -timeout 60s ./...
